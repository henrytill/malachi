#!/usr/bin/env bash

set -o errexit
set -o pipefail
set -o nounset

readonly PREFIXDEBUG="[DEBUG]"
readonly PREFIXERROR="[ERROR]"
readonly PREFIXLOG="[INFO]"

debug=0
showconfig=0

cwd="$(realpath .)"
scriptdir="$(realpath "$(dirname "${0}")")"
projroot="${scriptdir}/.."

source "${projroot}/lib/config.sh"

command -v git >/dev/null 2>&1
if test $? -ne 0
then
	error "git not found"
	exit 1
fi

usage() {
	cat <<EOF >&2
Usage: ${0} [-c] [-d] [directory]

Options:
    -c          Show configuration directories
    -d          Enable debug output

Arguments:
    directory   Git repository directory (default: current)
EOF
	exit 1
}

log() {
	if test "${debug}" = "1"
	then
		printf "%s %s\n" "${PREFIXDEBUG}" "${1}"
	fi
}

error() {
	printf "%s %s\n" "${PREFIXERROR}" "${1}" >&2
}

findrepo() {
	test $# -gt 1 && { error "usage: findrepo [directory]"; return 1; }
	local dir="${1:-${cwd}}"
	dir="$(realpath "${dir}")"

	while test "${dir}" != "/"
	do
		if test -d "${dir}/.git"
		then
			echo "${dir}"
			return 0
		fi

		dir="$(dirname "${dir}")"
	done

	return 1
}

firstrun() {
	test $# -eq 1 || { error "usage: firstrun cachepath"; return 1; }
	local cachepath="${1}"
	log "first run - generating add events for all files"
	mkdir -p "${cachepath}"
	git ls-tree -r --format="%(objectname) %(path)" HEAD | awk '{printf "op=added path=\"%s\" hash=%s\n", $2, $1}'
}

genevents() {
	test $# -eq 2 || { error "usage: genevents cached head"; return 1; }
	local cached="${1}"
	local head="${2}"
	git diff-tree --raw "${cached}" "${head}" | awk -f "${projroot}/lib/index.awk"
}

check() {
	test $# -eq 1 || { error "usage: check cachepath"; return 1; }
	local cachepath="${1}"
	git ls-tree -r --format="%(objectname) %(path)" HEAD | awk '{print $1, $2}' > "${cachepath}/index.txt"
}

main() {
	while getopts "cd" opt
	do
		case "${opt}" in
		c)
			showconfig=1
			;;
		d)
			debug=1
			;;
		*)
			usage
			;;
		esac
	done
	shift $((OPTIND - 1))

	configdir="$(getcachedir)"
	datadir="$(getdatadir)"
	cachedir="$(getcachedir)"

	if test "${showconfig}" = "1"
	then
		echo "configdir=${configdir}"
		echo "datadir=${datadir}"
		echo "cachedir=${cachedir}"
		exit 0
	fi

	targetdir="${1:-${cwd}}"

	repo="$(findrepo "${targetdir}")"
	if test $? -ne 0
	then
		error "no git directory"
		exit 1
	fi

	cd "${repo}"
	head="$(git rev-parse HEAD)"

	log "repo=${repo}"
	log "head=${head}"

	cachepath="${cachedir}/${repo}"
	headfile="${cachepath}/HEAD"

	if test ! -f "${headfile}"
	then
		firstrun "${cachepath}"
		echo "${head}" > "${headfile}"
		return
	fi

	cached="$(cat "${headfile}")"
	log "cached=${cached}"

	if test "${cached}" = "${head}"
	then
		log "no changes since last run"
		return
	fi

	genevents "${cached}" "${head}"
	echo "${head}" > "${headfile}"
}

main "$@"
