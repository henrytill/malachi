#!/usr/bin/env bash

set -o errexit
set -o pipefail
set -o nounset

readonly PREFIXDEBUG="[DEBUG]"
readonly PREFIXERROR="[ERROR]"

CWD="$(realpath .)"
SCRIPTDIR="$(dirname "$(realpath "${0}")")"

readonly CWD
readonly SCRIPTDIR

debug=0

usage() {
	cat <<EOF >&2
Usage: ${0} [-d] [directory]

Options:
    -d          Enable debug output

Arguments:
    directory   Git repository directory (default: current)
EOF
	exit 1
}

log() {
	if test "${debug}" = "1"
	then
		printf "%s %s\n" "${PREFIXDEBUG}" "${1}" >&2
	fi
}

error() {
	printf "%s %s\n" "${PREFIXERROR}" "${1}" >&2
}

findrepo() {
	test $# -gt 1 && { error "usage: findrepo [directory]"; return 1; }
	local dir="${1:-${CWD}}"
	git -C "${dir}" rev-parse --show-toplevel
}

firstrun() {
	test $# -eq 2 || { error "usage: firstrun repo head"; return 1; }
	local repo="${1}"
	local head="${2}"
	log "first run - generating add events for all files"
	git ls-tree -r --format="%(objectname) %(path)" "${head}" \
		| awk -v repo="${repo}" -v repohash="${head}" -f "${SCRIPTDIR}/../lib/firstrun.awk"
}

genevents() {
	test $# -eq 3 || { error "usage: genevents repo cached head"; return 1; }
	local repo="${1}"
	local cached="${2}"
	local head="${3}"
	git diff-tree --raw "${cached}" "${head}" \
		| awk -v repo="${repo}" -v repohash="${head}" -f "${SCRIPTDIR}/../lib/genevents.awk"
}

main() {
	command -v git >/dev/null 2>&1
	if test $? -ne 0
	then
		error "git not found"
		exit 1
	fi

	while getopts "d" opt
	do
		case "${opt}" in
		d)
			debug=1
			;;
		*)
			usage
			;;
		esac
	done
	shift $((OPTIND - 1))

	if test -n "${XDG_RUNTIME_DIR:-}"
	then
		runtimedir="${XDG_RUNTIME_DIR}/malachi"
	else
		uid="$(id -u)"
		runuser_dir="/run/user/${uid}"
		if test -d "${runuser_dir}" && test -w "${runuser_dir}"
		then
			runtimedir="${runuser_dir}/malachi"
		else
			runtimedir="/tmp/malachi-${uid}"
		fi
	fi

	targetdir="${1:-${CWD}}"
	repo="$(findrepo "${targetdir}")"
	if test $? -ne 0
	then
		error "no git directory"
		exit 1
	fi

	cd "${repo}"
	head="$(git rev-parse HEAD)"

	log "repo=${repo}"
	log "head=${head}"

	cachedrepos="${runtimedir}/roots"
	cachefile="${cachedrepos}${repo}"

	log "cachefile=${cachefile}"

	if ! test -f "${cachefile}"
	then
		if test -p "${runtimedir}/command"
		then
			firstrun "${repo}" "${head}" > "${runtimedir}/command"
		else
			log "daemon pipe not found, writing to stdout instead"
			firstrun "${repo}" "${head}"
		fi
		return
	fi

	cached="$(cat "${cachefile}")"

	if test "${cached}" = "${head}"
	then
		log "no changes since last run"
		return
	fi

	if test -p "${runtimedir}/command"
	then
		genevents "${repo}" "${cached}" "${head}" > "${runtimedir}/command"
	else
		log "daemon pipe not found, writing to stdout instead"
		genevents "${repo}" "${cached}" "${head}"
	fi
}

main "$@"
