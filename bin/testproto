#!/usr/bin/env bash

set -o errexit
set -o pipefail
set -o nounset

scriptdir="$(realpath "$(dirname "${0}")")"
projroot="${scriptdir}/.."

testdir="$(mktemp -d)"
cachedir="$(mktemp -d)"
echo "testdir=${testdir} cachedir=${cachedir}"

cd "${testdir}"
git init
git config user.name Test
git config user.email test@example.com

echo 'hello world' > file1.txt
echo 'foo bar' > file2.txt
git add .
git commit -m 'initial'

export XDG_CACHE_HOME="${cachedir}"
echo
echo '=== Initial run ==='
"${projroot}/bin/proto"

echo
echo '=== Cache contents ==='
find "${cachedir}" -type f | xargs -I {} awk 'FNR==1{print FILENAME ":"} {printf "%4s%s\n", "", $0}' {}

echo
echo '=== Second run ==='
"${projroot}/bin/proto"

echo 'modified' > file1.txt
git add file1.txt
git commit -m 'modify file1'

echo
echo '=== After modification ==='
"${projroot}/bin/proto"

echo
echo '=== Cache contents after modification ==='
find "${cachedir}" -type f | xargs -I {} awk 'FNR==1{print FILENAME ":"} {printf "%4s%s\n", "", $0}' {}

git rm file2.txt
git commit -m 'remove file2'

echo
echo '=== After removal ==='
"${projroot}/bin/proto"

echo
echo '=== Cache contents after removal ==='
find "${cachedir}" -type f | xargs -I {} awk 'FNR==1{print FILENAME ":"} {printf "%4s%s\n", "", $0}' {}

cd /
rm -rf "${testdir}" "${cachedir}"
