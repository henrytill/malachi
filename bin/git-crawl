#!/usr/bin/env perl

use strict;
use warnings;
use feature 'signatures';

use Cwd;
use File::Basename;
use File::Spec;
use Getopt::Std;
use Git;

# Try to use JSON::XS (fast), fall back to JSON::PP (pure Perl)
my $json_encoder;
BEGIN {
    eval {
        require JSON::XS;
        $json_encoder = JSON::XS->new->utf8->canonical;
        1;
    } or do {
        require JSON::PP;
        $json_encoder = JSON::PP->new->utf8->canonical;
    };
}

my $debug = 0;

sub usage() {
    print STDERR <<EOF;
Usage: $0 [-d]

Options:
    -d          Enable debug output
EOF
    exit 1;
}

sub dbg ($msg) {
    print STDERR "[DEBUG] $msg\n" if $debug;
}

sub getruntimedir () {
    my $uid = $<;
    my $runtimedir = $ENV{XDG_RUNTIME_DIR} || File::Spec->catdir(File::Spec->rootdir(), 'run', 'user', $uid);
    if (-d $runtimedir && -w $runtimedir) {
        return File::Spec->catdir($runtimedir, 'malachi');
    }
    return File::Spec->catdir(File::Spec->tmpdir(), "malachi-$uid");
}

sub send_json_message ($fh, $op, $path) {
    my $data = {
        op => $op,
        path => $path,
    };
    my $json = $json_encoder->encode($data);
    my $len = pack('L', length($json));  # native byte order uint32
    print $fh $len . $json;
    dbg("sent: $json");
}

sub main () {
    my %opts;
    getopts('d', \%opts) or usage();
    $debug = 1 if $opts{d};

    my ($gitrepo, $repo) = eval {
        my $d = $ENV{GIT_WORK_TREE} || cwd();
        my $g = Git->repository(Directory => $d);
        my $r = $g->wc_path() || dirname($g->repo_path());
        ($g, $r);
    } or die "no git directory";
    dbg("repo=$repo");

    my $head = $gitrepo->command_oneline('rev-parse', 'HEAD');
    dbg("head=$head");

    my $runtimedir = getruntimedir();
    my $commandpipe = File::Spec->catfile($runtimedir, 'command');
    dbg("runtimedir=$runtimedir");
    dbg("commandpipe=$commandpipe");

    # Check if daemon pipe exists
    unless (-p $commandpipe) {
        dbg("daemon pipe not found at $commandpipe");
        # For testing, we can write to stdout instead
        if ($debug) {
            send_json_message(\*STDOUT, 'add', $repo);
        }
        return;
    }

    # Send add command to daemon
    # The daemon will handle all Git operations (ls-tree, diff-tree, etc.)
    open my $fh, '>', $commandpipe or die "open $commandpipe: $!";
    send_json_message($fh, 'add', $repo);
    close $fh;
}

main() unless caller;
